<!DOCTYPE html>
<html>
<head>
  <title>Modules - Zeo</title>
  <link href="/css/style.css" rel=stylesheet>
  <link href="/css/header.css" rel=stylesheet>
</head>
<body>
  <!-- header.html -->
  <script>
window.$ = s => document.querySelectorAll(s);

$('navbar > a').forEach(el => {
  if (el.classList.contains('modules')) {
    el.classList.add('selected');
  } else {
    el.classList.remove('selected');
  }
});
  </script>
  <div class=content>
    <div class=load-status>Loading...</div>
    <div class=search-bar id=search-bar>
      <input type=text placeholder="Search modules" id=search-input>
      <a class=checkbox id=show-insecure-checkbox>
        <div class=checkbox-box></div>
        <div class=checkbox-label>Show insecure modules</div>
      </a>
    </div>
    <div class=load-placeholder>Sorry, I got nothin' :(</div>
    <div class=modules-body id=modules-body></div>
    <footer class=footer>
      <div class="footer-wrap full">
        <div class=footer-left><a href="/" class="link soft">Home</a> | <a href="https://github.com/modulesio/zeo" class="link soft">Github</a> | <a href="mailto:hello@zeovr.io" class="link soft">Contact</a></div>
        <div class=footer-right>&copy; 2017 <a href="mailto:a@zeovr.io">Zeo VR</a></div>
      </div>
    </footer>
  </div>
  <script src="/js/lib/creaturejs.js"></script>
  <script>
const loadStatus = $('.load-status')[0];
const loadPlaceholder = $('.load-placeholder')[0];
const modulesBody = $('#modules-body')[0];
const searchBar = $('#search-bar')[0];
const searchInput = $('#search-input')[0];
const showInsecureCheckbox = $('#show-insecure-checkbox')[0];

const _makeModuleElement = module => {
  const {name} = module;

  const div = document.createElement('div');
  div.innerHTML = `<div class=module>
    <img class=module-image />
    <div class=module-content>
      <div class=module-header>
        <div class=module-header-wrap>
          <a href="/modules/${module.name}" class=name>${module.displayName}</a>
          <div class=version>${module.version}</div>
        </div>
      </div>
      <div class=description>${module.description}</div>
    </div>
  </div>`;
  const moduleElement = div.childNodes[0];

  setTimeout(() => {
    moduleElement.querySelectorAll('.module-image')[0].src = creaturejs.makeStaticCreature('module:' + name);
  });

  return moduleElement;
};
const _cancelableFetch = (url, options) => {
  let live = true;
  const result = new Promise((accept, reject) => {
    fetch(url, options)
      .then(res => {
        if (live) {
          return res.json();
        } else {
          return Promise.resolve();
        }
      })
      .then(json => {
        if (live) {
          accept(json);
        }
      })
      .catch(err => {
        if (live) {
          reject(err);
        }
      });
  });
  result.cancel = () => {
    live = false;
  };
  return result;
};
const _update = () => {
  loadStatus.style.display = 'flex';
  loadPlaceholder.style.display = 'none';

  modulesBody.style.display = 'none';
  searchBar.style.display = 'none';

  let searchPromise = null;
  const _search = (q = '', i = false) => {
    if (searchPromise) {
      searchPromise.cancel();
    }

    searchPromise = _cancelableFetch(`/modules/modules.json?q=${encodeURIComponent(q)}&i=${i}`);
    searchPromise
      .then(modules => {
        while (modulesBody.hasChildNodes()) {
          modulesBody.removeChild(modulesBody.lastChild);
        }
        for (let i = 0; i < modules.length; i++) {
          const module = modules[i];
          const moduleElement = _makeModuleElement(module);
          modulesBody.appendChild(moduleElement);
        }
        modulesBody.style.display = modules.length > 0 ? 'flex' : 'none';
        loadPlaceholder.style.display = modules.length === 0 ? 'flex' : 'none';

        loadStatus.style.display = 'none';
        searchBar.style.display = 'flex';
      });
  };
  _search();

  const _refreshSearch = () => {
    _search(searchInput.value, showInsecure);
  };

  searchInput.addEventListener('input', () => {
    _refreshSearch();
  });

  let showInsecure = false;
  showInsecureCheckbox.addEventListener('click', () => {
    showInsecure = !showInsecure;

    if (showInsecure) {
      showInsecureCheckbox.classList.add('checked');
    } else {
      showInsecureCheckbox.classList.remove('checked');
    }

    _refreshSearch();
  });
};
_update();
  </script>
</body>
</html/>
