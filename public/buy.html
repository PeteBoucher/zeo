<!DOCTYPE html>
<html>
<head>
  <title>Buy - Zeo</title>
  <link href="/css/style.css" rel=stylesheet>
  <link href="/css/header.css" rel=stylesheet>
  <link href="/css/github-markdown.css" rel=stylesheet>
</head>
<body>
  <!-- begin header -->
  <header class=header>
    <div class=header-left>
      <a href="https://zeovr.io" class=header-logo-anchor><img width=32 height=51 src="/img/logo.png" class=header-icon>zeo vr</a>
    </div>
    <navbar>
      <a href="/" class="try blue selected">Try it</a>
      <a href="/docs" class="documentation blue">Documentation</a>
      <a href="/modules" class="modules blue">Modules</a>
      <a href="/servers" class="servers blue">Servers</a>
      <a href="/forum" class="forum blue">Forum</a>
    </navbar>
    <div class=header-right>
      <navbar>
        <a href="/id" class="id green">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path class="outline" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            <path d="M0 0h24v24H0z" fill="none"/>
          </svg>
          <span>VRID</span>
        </a>
      </navbar>
      <a href="https://github.com/modulesio/zeo" class="header-anchor github">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"/></svg>
        <span>Github</span>
      </a>
    </div>
  </header>
  <!-- end header -->
  <script>
window.$ = s => document.querySelectorAll(s);

$('navbar > a').forEach(el => {
  el.classList.remove('selected');
});
  </script>
  <div class=content>
    <div class=buy-body>
      <div class=confirm-body style="display: none;" id=confirm-body>
        <h1>Confirm payment</h1>
        <div class=row>
          <div id=buy-src-body></div>
          <img src="/img/arrow-right.svg">
          <div id=buy-dst-body></div>
        </div>
        <div class=row>
          <a class="button primary" id=confirm-button>Confirm</a>
          <a class=button id=cancel-button>Cancel</a>
          <a class="button primary static" style="display: none;" id=paying-button>Paying...</a>
        </div>
      </div>
      <div class=error-body style="display: none;" id=error-body>
        <h1>Confirm payment</h1>
        <div class=row>
          <div class=error>Whoops! Not enough funds :/</div>
        </div>
      </div>
    </div>
    <footer class=footer>
      <div class="footer-wrap full">
        <div class=footer-left><a href="/" class="link soft">Home</a> | <a href="https://github.com/modulesio/zeo" class="link soft">Github</a> | <a href="mailto:hello@zeovr.io" class="link soft">Contact</a></div>
        <div class=footer-right>&copy; 2017 <a href="mailto:a@zeovr.io">Zeo VR</a></div>
      </div>
    </footer>
  </div>
  <script src="/js/lib/creaturejs.js"></script>
  <script>
const buySrcBody = $('#buy-src-body')[0];
const buyDstBody = $('#buy-dst-body')[0];

const _commaize = n => String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
const _makeAssetElement = (asset, quantity) => {
  const quantityString = _commaize(quantity);

  const el = document.createElement('div');
  el.classList.add('asset');
  el.style.cssText = 'position: relative; display: flex; width: 300px; height: 100px; background-color: #EEE; padding-left: 30px; text-decoration: none; overflow: hidden; box-sizing: border-box;';
  el.innerHTML = `\
    <div style="display: flex; position: absolute; top: 40px; left: -40px; width: 100px; height: 20px; background-color: #FFC107; font-size: 13px; justify-content: center; align-items: center; box-sizing: border-box; transform: rotate(-90deg);">Asset</div>
    <div style="display: flex; margin-left: -30px; padding-left: 20px; flex-grow: 1; flex-direction: column; box-sizing: border-box;">
      <div style="display: flex; flex-grow: 1;">
        <img class=asset-image width="50" height="50" style="margin: 10px; image-rendering: -moz-crisp-edges; image-rendering: pixelated;" />
        <div style="display: flex; max-width: ${300 - (20) - (50 + (10 * 2)) - (30 + (15 * 2))}px; flex-grow: 1; flex-direction: column; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
          <h1 style="margin: 0; margin-top: 15px; padding: 0; font-size: 16px; font-weight: 600; line-height: 1.4;">${asset}</h1>
          <div style="display: flex; flex-grow: 1; align-items: center;">
            <div style="padding: 0 7px; border: 2px solid; font-size: 16px; font-weight: 400;">&#164; ${quantityString}</div>
          </div>
        </div>
      </div>
    </div>
  `;
  return el;
};
const _update = () => {
  const _requestStatus = () => fetch('/wallet/api/status', {
    credentials: 'include',
  })
    .then(res => res.json());

  _requestStatus()
    .then(walletStatus => {
      const match = window.location.pathname.match(/(?:\?([\s\S]+))?$/);
      const queryString = match[1] || '';
      const query = parseQueryString(queryString);
      const {srcAsset, srcQuantity: srcQuantityString, dstAsset, dstQuantity: dstQuantityString} = query;
      const srcQuantity = parseInt(srcQuantityString, 10);
      const dstQuantity = parseInt(dstQuantityString, 10);

      const confirmBody = $('#confirm-body')[0];
      const errorBody = $('#error-body')[0];
      const confirmButton = $('#confirm-button')[0];
      const cancelButton = $('#cancel-button')[0];
      const payingButton = $('#paying-button')[0];

      const hasAvailableFunds = walletStatus.assets.some(({asset, quantity}) => asset === srcAsset && quantity >= srcQuantity);

      if (hasAvailableFunds) {
        const srcBuyElement = _makeAssetElement(srcAsset, srcQuantity);
        buySrcBody.appendChild(srcBuyElement);
        const dstBuyElement = _makeAssetElement(dstAsset, dstQuantity);
        buyDstBody.appendChild(dstBuyElement);

        setTimeout(() => {
          srcBuyElement.querySelectorAll('.asset-image')[0].src = creaturejs.makeStaticCreature('asset:' + srcAsset);
          dstBuyElement.querySelectorAll('.asset-image')[0].src = creaturejs.makeStaticCreature('asset:' + dstAsset);
        });

        confirmBody.style.display = 'block';

        confirmButton.addEventListener('click', () => {
          confirmButton.style.display = 'none';
          cancelButton.style.display = 'none';
          payingButton.style.display = 'flex';

          fetch('/wallet/api/buy', {
            method: 'POST',
            headers: (() => {
              const headers = new Headers();
              headers.append('Content-Type', 'application/json');
              return headers;
            })(),
            body: JSON.stringify({
              srcAsset,
              srcQuantity,
              dstAsset,
              dstQuantity,
            }),
            credentials: 'include',
            mode: 'cors',
          })
            .then(res => {
              if (res.status >= 200 && res.status < 300) {
                return res.json();
              } else if (res.status === 412) { // precondition failed
                const err = new Error('could not find immediate counterorder');
                return Promise.reject(err);
              } else {
                const err = new Error('API returned failure status code: ' + res.status);
                return Promise.reject(err);
              }
            })
            .then(result => result.txid)
            .then(txid => {
              window.location.href = `/buy-success?txid=${encodeURIComponent(txid)}`;
            })
            .catch(err => {
              console.warn(err);

              confirmButton.style.display = 'flex';
              cancelButton.style.display = 'flex';
              payingButton.style.display = 'none';
            });
        });
        cancelButton.addEventListener('click', () => {
          window.history.back();
        });
      } else {
        errorBody.style.display = 'block';
      }
    });
};
_update();

function parseQueryString(s) {
  const result = {};
  const query = window.location.search.substring(1);
  const vars = query.split('&');
  for (let i = 0; i < vars.length; i++) {
    const pair = vars[i].split('=');
    result[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
  }
  return result;
}
  </script>
</body>
</html/>
